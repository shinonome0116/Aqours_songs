<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Aqours歌詞一覧</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        a {
            cursor: pointer;
            color: #0000FF;
            text-decoration:underline;
        }
        .songs-container{
            .song {
                margin-bottom: 20px;
            }
            .song-title, .hint-title {
                font-weight: bold;
                font-size: 1.2em;
            }
            .song-lyrics {
                margin-top: 10px;
                margin-bottom: 16px;
                white-space: pre-wrap;
            }
        }
        .index-container{
            margin-bottom: 16px;
            .song {
                margin-bottom: 4px;
                cursor: pointer;
                color: #0000FF;
                text-decoration:underline;
            }
        }
        .keyword-input {
            display: flex;
            .input-box {
                display: flex;
                flex-wrap: wrap;
                margin-right: 16px;
            }
            .serch-method {
                > * {
                    margin-right: 8px;
                }
                display: flex;
            }
        }
        .member, .attribute {
            .checkboxlist {
                display:flex;
                flex-wrap: wrap;
                margin-bottom: 8px;
                div {
                    margin-right: 32px;
                }
            }
        }
        .filter-conditions {
            margin-bottom: 32px;
            >div {
                margin-bottom: 8px;
            }
        }
        .highlight {
            background-color: #00FFFF;
        }
        .setting {
            display: flex;
            flex-wrap: wrap;
            >* {
                margin-right: 8px;
            }
        }
    </style>
</head>
<body>

    <h1>Aqours歌詞一覧</h1>
    <div class="filter-conditions" id="filter-conditions">
        <div class="lyrics">
            <div class="title">
                <label for="filterInput">歌詞で絞り込み:</label>
            </div>
            <div class="keyword-input">
                <div class="input-box">
                    <input type="text" id="lyrics" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method">
                    <input type="checkbox" id="lyrics_or">        
                    <div>OR検索にする（デフォルトは空白区切りのand検索）</div>       
                </div>
            </div>
        </div>
        <div class="writer">
            <div class="title">
                <label for="filterInput">作詞者で絞り込み:</label>
            </div>
            <div class="keyword-input">
                <div class="input-box">
                    <input type="text" id="writer" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method">
                    <input type="checkbox" id="writer_or">        
                    <div>OR検索にする</div>       
                </div>
            </div>
        </div>
        <div class="composition">
            <div class="title">
                <label for="filterInput">作曲者で絞り込み:</label>
            </div>
            <div class="keyword-input">
                <div class="input-box">
                    <input type="text" id="composition" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method">
                    <input type="checkbox" id="composition_or">        
                    <div>OR検索にする</div>       
                </div>
            </div>
        </div>
        <div class="arrangement">
            <div class="title">
                <label for="filterInput">編曲者で絞り込み:</label>
            </div>
            <div class="keyword-input">
                <div class="input-box">
                    <input type="text" id="arrangement" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method">
                    <input type="checkbox" id="arrangement_or">
                    <div>OR検索にする</div>            
                </div>
            </div>
        </div>       
        <div class="member">
            <div class="title">
                <label for="filterInput">メンバーまたはユニットで絞り込み（OR検索）:</label>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="chika">
                    <label for="chikaCheckbox">千歌</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="riko">
                    <label for="rikoCheckbox">梨子</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="kanan">
                    <label for="rikoCheckbox">果南</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="dia">
                    <label for="rikoCheckbox">ダイヤ</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="you">
                    <label for="rikoCheckbox">曜</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="yoshiko">
                    <label for="rikoCheckbox">善子</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="hanamaru">
                    <label for="rikoCheckbox">花丸</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="mari">
                    <label for="rikoCheckbox">鞠莉</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="ruby">
                    <label for="rikoCheckbox">ルビィ</label>
                </div>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="cyaron">
                    <label for="chikaCheckbox">CYaRon!</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="azalea">
                    <label for="rikoCheckbox">AZALEA</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="guiltyKiss">
                    <label for="rikoCheckbox">Guilty Kiss</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="yyy">
                    <label for="rikoCheckbox">わいわいわい</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="saintSnow">
                    <label for="rikoCheckbox">Saint Snow</label>
                </div>
            </div>
        </div>
        <div class="attribute">
            <div class="title">
                <label for="filterInput">曲の属性で絞り込み（OR検索）:</label>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="aqours">
                    <label for="chikaCheckbox">全員曲</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="unit">
                    <label for="rikoCheckbox">ユニット</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="solo">
                    <label for="rikoCheckbox">ソロ</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="grade">
                    <label for="rikoCheckbox">学年</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="duoTrio">
                    <label for="rikoCheckbox">デュオトリオ（ヨハネ含む）</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="saintAqoursSnow">
                    <label for="rikoCheckbox">セイントアクアスノー</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="yohane">
                    <label for="rikoCheckbox">幻日のヨハネ</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="small">
                    <label for="rikoCheckbox">その他少人数編成</label>
                </div>
            </div>
        </div>
        
        <div class="setting">
            <div class="title">
                <label for="filterInput">その他設定:</label>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="highlight">
                    <label for="chikaCheckbox">検索キーワードをハイライトする</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="index">
                    <label for="chikaCheckbox">目次を表示する</label>
                </div>
            </div>
        </div>

        <div class="setting">
            <div class="title">
                <label for="filterInput">その他の機能:</label>
            </div>
            <div class="serch-execute">
                <button id="clearButton">検索条件をクリア</button>
            </div>
            <div class="serch-execute">
                <button id="hintButton">ヒント</button>
            </div>
        </div>

        <div class="setting">
            <div class="title">
                <label for="filterInput">検索実行:</label>
            </div>
            <div class="serch-execute">
                <button id="filterButton">検索</button>
            </div>
        </div>
    </div>
    <div id="index-container" class="index-container"></div>
    <div id="songs-container" class="songs-container"></div>

    <script>
        // service workerの登録関係
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service_worker.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        }
        // CSVファイルのパス（dataフォルダ内）
        const songFilePath = 'data/songs.csv';
        const hintFilePath = 'data/hint.json';
        let songs;
        let hints;
        const songElements = {
            title: {
                type: "includes"
            },
            lyrics: {
                type: "includes"
            },
            writer: {
                type: "includes"
            },
            arrangement: {
                type: "includes"
            },
            lyrics: {
                type: "includes"
            },
            chika: {
                type: "member"
            },
            riko: {
                type: "member"
            },
            kanan: {
                type: "member"
            },
            dia: {
                type: "member"
            },
            you: {
                type: "member"
            },
            yoshiko: {
                type: "member"
            },
            hanamaru: {
                type: "member"
            },
            mari: {
                type: "member"
            },
            ruby: {
                type: "member"
            },
            cyaron: {
                type: "member"
            },
            azalea: {
                type: "member"
            },
            guiltyKiss: {
                type: "member"
            },
            yyy: {
                type: "member"
            },
            saintSnow: {
                type: "member"
            },
            aqours: {
                type: "attribute"
            },
            unit: {
                type: "attribute"
            },
            solo: {
                type: "attribute"
            },
            grade: {
                type: "attribute"
            },
            duoTrio: {
                type: "attribute"
            },
            saintAqoursSnow: {
                type: "attribute"
            },
            yohane: {
                type: "attribute"
            },
            small: {
                type: "attribute"
            }
        }
        const filterLabels = Object.keys(songElements);
        let filterConditions = {
            title: {
                value: []
            },
            lyrics: {
                value: []
            },
            writer: {
                value: []
            },
            arrangement: {
                value: []
            },
            lyrics: {
                value: []
            }
        };

        // ページが読み込まれたときにCSVを読み込む
        window.onload = function() {
            fetch(songFilePath)
                .then(response => response.text())  // CSVファイルをテキストとして取得
                .then(csvContent => {
                    songs = parseCSV(csvContent);  // CSVの内容を解析
                    displaySongs(songs);
                })
                .catch(error => {
                    console.error('CSVファイルの読み込みエラー:', error);
                });
            
            fetch(hintFilePath)
                .then(response => response.json())  // CSVファイルをテキストとして取得
                .then(hintJson => {
                    hints = hintJson;
                    console.log(hints);
                })
                .catch(error => {
                    console.error('CSVファイルの読み込みエラー:', error);
                });
        };

        // 検索実行時の処理
        document.getElementById('filterButton').addEventListener('click', function() {
            // 入力フォームから検索条件を読み込み
            getCondition();
            console.log(filterConditions);
            displaySongs(filteredSongs(filterConditions));
        });

        document.getElementById('clearButton').addEventListener('click', function() {
            // 検索条件をクリア
            filterLabels.forEach(filterLabel => {
                let enteredElement = document.getElementById(filterLabel);
                if(enteredElement) {
                    if(songElements[filterLabel].type === "includes" && enteredElement.value.trim().length > 0) {
                        // 文字入力の場合はスペース区切り
                        document.getElementById(filterLabel + "_or").checked = false;
                        enteredElement.value = "";
                    } else if(songElements[filterLabel].type === "member" || songElements[filterLabel].type === "attribute") {
                        enteredElement.checked = false;
                    }
                    
                }
            })
        });

        // ヒントコーナーの曲を表示する関数
        document.getElementById('hintButton').addEventListener('click', function() {
            const indexContainer = document.getElementById('index-container');
            indexContainer.innerHTML = '';  // 既存の内容をクリア

            const container = document.getElementById('songs-container');
            container.innerHTML = '';  // 既存の内容をクリア

            for(let i=0; i < hints.length; i++) {
                const hintDiv = document.createElement('div');
                hintDiv.classList.add('hint');

                const hintTitleDiv = document.createElement('div');
                hintTitleDiv.classList.add('hint-title');
                hintTitleDiv.textContent = "第" + (i+1) + "回";
                hintDiv.appendChild(hintTitleDiv);

                getCondition();

                for(let j = 0; j < hints[i].length; j++ ) {
                    const displayedSong = songs.find(song => {
                        return song.id === hints[i][j];
                    });
                    const songDiv = document.createElement('div');
                    songDiv.classList.add('song');

                    const titleDiv = document.createElement('div');
                    titleDiv.classList.add('song-title');
                    titleDiv.textContent = displayedSong.title;

                    const lyricsDiv = document.createElement('div');
                    lyricsDiv.classList.add('song-lyrics');
                    lyricsDiv.appendChild(highlightText(displayedSong.lyrics,filterConditions.lyrics.value, document.getElementById("highlight").checked));

                    songDiv.appendChild(titleDiv);
                    songDiv.appendChild(lyricsDiv);
                    hintDiv.appendChild(songDiv);
                    container.appendChild(hintDiv);
                }
            }

            for(let i=0; i < hints.length; i++) {
                const hintDiv = document.createElement('div');
                hintDiv.classList.add('hint');

                const hintTitleDiv = document.createElement('div');
                hintTitleDiv.classList.add('hint-title');
                hintTitleDiv.textContent = "第" + (i+1) + "回";
                hintDiv.appendChild(hintTitleDiv);

                getCondition();

                for(let j = 0; j < hints[i].length; j++ ) {
                    const displayedSong = songs.find(song => {
                        return song.id === hints[i][j];
                    });
                    const songDiv = document.createElement('div');
                    songDiv.classList.add('song');

                    const titleDiv = document.createElement('div');
                    titleDiv.classList.add('song-title');
                    titleDiv.textContent = displayedSong.title;

                    const lyricsDiv = document.createElement('div');
                    lyricsDiv.classList.add('song-lyrics');
                    lyricsDiv.appendChild(highlightText(displayedSong.lyrics,filterConditions.lyrics.value, document.getElementById("highlight").checked));

                    songDiv.appendChild(titleDiv);
                    songDiv.appendChild(lyricsDiv);
                    hintDiv.appendChild(songDiv);
                    container.appendChild(hintDiv);
                }
            }
                
        });


        // 曲名と歌詞を画面に表示する
        function displaySongs(songs) {
            const indexContainer = document.getElementById('index-container');
            indexContainer.innerHTML = '';  // 既存の内容をクリア

            // 目次を表示
            if(document.getElementById("index").checked) {
                songs.forEach(song => {
                    const songDiv = document.createElement('div');
                    songDiv.classList.add('song');

                    const titleDiv = document.createElement('div');
                    titleDiv.classList.add('song-title');
                    titleDiv.textContent = song.title;
                    titleDiv.addEventListener('click', function() {
                        document.getElementById(song.id).scrollIntoView({
                            block: 'start'
                        });
                    });

                    songDiv.appendChild(titleDiv);
                    indexContainer.appendChild(songDiv);
                });
            }

            // 歌詞を表示
            const songsContainer = document.getElementById('songs-container');
            songsContainer.innerHTML = '';  // 既存の内容をクリア

            songs.forEach(song => {
                const backButton = document.createElement('a');
                backButton.textContent = "トップへ戻る";
                backButton.addEventListener('click', function() {
                    document.getElementById('filter-conditions').scrollIntoView({
                        block: 'start'
                    });
                });
                const songDiv = document.createElement('div');
                songDiv.classList.add('song');
                songDiv.id = song.id;

                const titleDiv = document.createElement('div');
                titleDiv.classList.add('song-title');
                titleDiv.textContent = song.title;

                const lyricsDiv = document.createElement('div');
                lyricsDiv.classList.add('song-lyrics');
                lyricsDiv.appendChild(highlightText(song.lyrics,filterConditions.lyrics.value, document.getElementById("highlight").checked));

                songDiv.appendChild(titleDiv);
                songDiv.appendChild(lyricsDiv);
                songDiv.appendChild(backButton);

                songsContainer.appendChild(songDiv);
            });
        }

         /**
         * CSVをパースして配列を返す関数
         * @param {string} csvContent - CSVファイルの内容
         * @returns {Array} - オブジェクトの配列（行ごとに分かれたデータ）
         */
         function parseCSV(csvContent) {
            const rows = [];
            const parsedData = [];
            const jsonData = [];
            let insideQuotes = false;
            let currentRow = '';

            // 文字列ごとに解析
            for (let i = 0; i < csvContent.length; i++) {
                const char = csvContent[i];
                if (char === '"') {
                    insideQuotes = !insideQuotes; // クオート内外の状態を切り替える
                    currentRow += char; // 現在の列に文字を追加
                } else if (char === '\n' && !insideQuotes) {
                    rows.push(currentRow.trim()); // 改行が区切り文字として認識
                    currentRow = ''; // 新しい列の準備
                } else {
                    currentRow += char; // 現在の列に文字を追加
                }
            }

            rows.forEach(row => {
                const columns = [];
                let currentColumn = '';
                let insideQuotes = false;

                // 文字列ごとに解析
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];

                    // ダブルクオートが出てきた場合
                    if (char === '"') {
                        if (row[i-1]===',' || row[i+1]===',' || i===0 || i === row.length - 1) {
                            insideQuotes = !insideQuotes; // クオート内外の状態を切り替える
                        }
                        else if(row[i-1] !=='"') {
                            currentColumn += char;
                        }
                        
                    } else if (char === ',' && !insideQuotes) {
                        columns.push(currentColumn.trim()); // カンマが区切り文字として認識
                        currentColumn = ''; // 新しい列の準備
                    } else {
                        currentColumn += char; // 現在の列に文字を追加
                    }
                }

                // 最後の列を追加
                if (currentColumn !== '') {
                    columns.push(currentColumn.trim());
                }


                // 行をデータに追加
                parsedData.push(columns);

            });
            
            for (let i = 1; i < parsedData.length; i++) {
                let row = {};
                for (let j = 0; j < parsedData[i].length; j++) {
                    if(parsedData[i][j] === 'TRUE') {
                        row[parsedData[0][j]] = true;
                    } else if(parsedData[i][j] === 'FALSE') {
                        row[parsedData[0][j]] = false;
                    } else {
                        row[parsedData[0][j]] = parsedData[i][j];
                    }
                }
                jsonData.push(row);
            }
            console.log(jsonData);

            return jsonData;
        }

        // 曲を絞り込む
        function filteredSongs(filterCondition) {
            console.log(filterCondition);
            return songs.filter(song => {
                return checkSongs(song, filterCondition)
            });
        }

        // 曲が検索条件に当てはまるかを判定する関数
        function checkSongs(song, filterCondition) {
            let filterConditionLabels = Object.keys(filterCondition);

            // 文字列検索を実施
            let includeResult = true;
            filterConditionLabels.filter(filterConditionLabel => songElements[filterConditionLabel].type === 'includes').forEach(filterConditionLabel => {
                // and検索ならtrueから始めて不一致条件があればfalseにする。or検索ならfalseから初めて一致条件があればtrueにする
                let eachResult = !filterCondition[filterConditionLabel].orSearch;
                filterCondition[filterConditionLabel].value.forEach(keyword => {
                    // 検索キーワードが含まれていた場合の処理
                    if(song[filterConditionLabel].toLowerCase().includes(keyword)) {
                        // or検索なら結果をtrueにする
                        if(filterCondition[filterConditionLabel].orSearch) {
                            eachResult = true;
                        }
                    } else {
                        // 検索キーワードが含まれていなかった場合の処理
                        // and検索なら結果をfalseにする
                        if(!filterCondition[filterConditionLabel].orSearch) {
                            eachResult = false;
                        }
                    }
                })
                if(!eachResult) {
                    includeResult = false;
                }
            })

            if(!includeResult) {
                return false
            }

            // メンバー検索を実施。OR条件で検索する
            const memberConditionsLabels = filterConditionLabels.filter(filterConditionLabel => songElements[filterConditionLabel].type === 'member' && filterCondition[filterConditionLabel] === true);
            let memberResult = true;
            if(memberConditionsLabels.length > 0) {
                memberResult = false;
                memberConditionsLabels.forEach(filterConditionLabel => {
                    if(song[filterConditionLabel] === filterCondition[filterConditionLabel]) {
                        memberResult = true;
                    }
                })
            }

            if(!memberResult) {
                return false
            }

            // 属性検索を実施。OR条件で検索する
            const attributeConditionsLabels = filterConditionLabels.filter(filterConditionLabel => songElements[filterConditionLabel].type === 'attribute' && filterCondition[filterConditionLabel] === true);
            let attributeResult = true;
            if(attributeConditionsLabels.length > 0) {
                attributeResult = false;
                attributeConditionsLabels.forEach(filterConditionLabel => {
                    if(song[filterConditionLabel] === filterCondition[filterConditionLabel]) {
                        attributeResult = true;
                    }
                })
            }

            
            if(!attributeResult) {
                return false
            }

            return true;
        }

        // ハイライトして表示するための関数
        function highlightText(text, condition, setting) {
            // 結果を入れるためのdivタグを作成
            const textDiv = document.createElement('div');

            if(condition.length === 0 || !setting) {
                textDiv.textContent = text;
                return textDiv;
            }

            // 検索キーワードで分割
            const separator = RegExp("(" + condition.join("|") + ")");
            console.log(separator);
            splitedTexts = text.split(separator);

            const conditionRegex = RegExp("^" + condition.join("|") + "$");
            // spanタグに分割し、検索キーワードに該当する時だけハイライトのクラスを入れる
            splitedTexts.forEach(splitedText => {
                const span = document.createElement('span');
                span.textContent = splitedText;
                if(conditionRegex.test(splitedText)) {
                    span.classList.add('highlight');
                }
                textDiv.appendChild(span);
            })

            return textDiv
        }

        // 入力フォームの検索条件を読み込む関数
        function getCondition() {
            filterLabels.forEach(filterLabel => {
                let enteredElement = document.getElementById(filterLabel);
                if(enteredElement) {
                    if(songElements[filterLabel].type === "includes") {
                        if(enteredElement.value.trim().length > 0) {
                            // 文字入力の場合はスペース区切り
                            filterConditions[filterLabel] = { orSearch: document.getElementById(filterLabel + "_or").checked };
                            filterConditions[filterLabel].value = enteredElement.value.toLowerCase().split(/ |　/);
                        } else {
                            filterConditions[filterLabel].value = [];
                        }
                    } else if(songElements[filterLabel].type === "member" || songElements[filterLabel].type === "attribute") {
                        filterConditions[filterLabel] = enteredElement.checked;
                    }
                    
                }
            })
        }
        
    </script>

</body>
</html>
