<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2W3VH63SBB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-2W3VH63SBB');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
     <!-- BootstrapのCSS読み込み -->
    <link rel="stylesheet" href="css/bootstrap.css">
    <!-- Bootstrapのjs読み込み -->
    <script src="js/bootstrap.bundle.js"></script>
    <title>Aqours歌詞一覧</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            scroll-behavior: auto;
            background: 
                linear-gradient(
                    to bottom, 
                    white 0%, 
                    white 800px,
                    #6CB3EA calc(50% + 400px), 
                    #123098 100%
                );
            background-position: top, 100px 0; /* 各レイヤーの位置を指定 */
            background-repeat: no-repeat;
        }
        .numazu {
            background-image: url("images/bg.jpg");
            background-repeat: no-repeat;
            background-position: center top;
        }
        .content {
            background: linear-gradient(
                to right, 
                rgba(255, 255, 255, 0), 
                rgba(255, 255, 255, 1) 8px, 
                rgba(255, 255, 255, 1) calc(100% - 8px), 
                rgba(255, 255, 255, 0)
            );
            
            background: linear-gradient(
            );
        }
        a {
            cursor: pointer;
        }
        .songs-container{
            .song {
                margin-bottom: 20px;
            }
            .song-title, .hint-title {
                font-weight: bold;
                font-size: 1.2em;
            }
            .song-title {
                background-color: #19b1f6;
            }
            .song-lyrics {
                margin-top: 10px;
                margin-bottom: 16px;
                white-space: pre-wrap;
            }
        }
        .index-container{
            margin-bottom: 16px;
            .hint {
                margin-bottom: 16px;
            }
            .hint-title {
                font-weight: bold;
                font-size: 1.2em;
            }
            .song {
                margin-bottom: 4px;
            }
        }
        .keyword-input {
            display: flex;
            .input-box {
                display: flex;
                flex-wrap: wrap;
                margin-right: 16px;
                .input {
                    width: 100%;
                }
            }
            .serch-method {
                > * {
                    margin-right: 8px;
                }
                display: flex;
            }
        }
        .member, .attribute {
            .checkboxlist {
                display:flex;
                flex-wrap: wrap;
                margin-bottom: 8px;
                div {
                    margin-right: 32px;
                }
            }
        }
        .filter-conditions {
            margin-bottom: 32px;
            >div {
                margin-bottom: 8px;
            }
        }
        .highlight {
            background-color: #00FFFF;
        }
    </style>
</head>
<body>
    <div class="numazu">
    <div class="container">
    <div class="mx-md-5 px-3 content">
    <h1><img src="images/Aqours.png" height="72px" class="me-1">歌詞一覧</h1>
    <div class="filter-conditions" id="filter-conditions">
        <div class="title">
            <div class="title row">
                <label for="filterInput" class="fw-bold">曲名で絞り込み:</label>
            </div>
            <div class="keyword-input row">
                <div class="input-box col-7">
                    <input type="text" id="title" class="form-control" placeholder="キーワードを入力してください" width="100%">                    
                </div>
                <div class="serch-method col-4">
                    <input type="checkbox" class="form-check-input" id="title_or">        
                    <div class="form-check-label">OR検索</div> 
                </div>
            </div>
        </div>
        <div class="lyrics">
            <div class="title row">
                <label for="filterInput" class="fw-bold">歌詞で絞り込み:</label>
            </div>
            <div class="keyword-input row">
                <div class="input-box col-7">
                    <input type="text" id="lyrics" class="form-control" placeholder="キーワードを入力してください" width="100%">                    
                </div>
                <div class="serch-method col-4">
                    <input type="checkbox" class="form-check-input" id="lyrics_or">        
                    <div class="form-check-label">OR検索</div> 
                </div>
            </div>
        </div>
        <div class="writer">
            <div class="title">
                <label for="filterInput row" class="fw-bold">作詞者で絞り込み:</label>
            </div>
            <div class="keyword-input row">
                <div class="input-box col-7">
                    <input type="text" id="writer" class="form-control" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method col-4">
                    <input type="checkbox" class="form-check-input" id="writer_or">        
                    <div class="form-check-label">OR検索</div>       
                </div>
            </div>
        </div>
        <div class="composition">
            <div class="title">
                <label for="filterInput" class="fw-bold">作曲者で絞り込み:</label>
            </div>
            <div class="keyword-input row">
                <div class="input-box col-7">
                    <input type="text" id="composition" class="form-control" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method col-4">
                    <input type="checkbox" class="form-check-input" id="composition_or">        
                    <div class="form-check-label">OR検索</div>       
                </div>
            </div>
        </div>
        <div class="arrangement">
            <div class="title">
                <label for="filterInput" class="fw-bold">編曲者で絞り込み:</label>
            </div>
            <div class="keyword-input row">
                <div class="input-box col-7">
                    <input type="text" id="arrangement" class="form-control" placeholder="キーワードを入力してください">                    
                </div>
                <div class="serch-method col-4">
                    <input type="checkbox" class="form-check-input" id="arrangement_or">
                    <div class="form-check-label">OR検索</div>            
                </div>
            </div>
        </div>       
        <div class="member">
            <div class="title">
                <label for="filterInput" class="fw-bold">メンバーまたはユニットで絞り込み（OR検索）:</label>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="chika">
                    <label for="chikaCheckbox">千歌</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="riko">
                    <label for="rikoCheckbox">梨子</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="kanan">
                    <label for="rikoCheckbox">果南</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="dia">
                    <label for="rikoCheckbox">ダイヤ</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="you">
                    <label for="rikoCheckbox">曜</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="yoshiko">
                    <label for="rikoCheckbox">善子</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="hanamaru">
                    <label for="rikoCheckbox">花丸</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="mari">
                    <label for="rikoCheckbox">鞠莉</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="ruby">
                    <label for="rikoCheckbox">ルビィ</label>
                </div>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="cyaron">
                    <label for="chikaCheckbox">CYaRon!</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="azalea">
                    <label for="rikoCheckbox">AZALEA</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="guiltyKiss">
                    <label for="rikoCheckbox">Guilty Kiss</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="yyy">
                    <label for="rikoCheckbox">わいわいわい</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="saintSnow">
                    <label for="rikoCheckbox">Saint Snow</label>
                </div>
            </div>
        </div>
        <div class="attribute">
            <div class="title">
                <label for="filterInput" class="fw-bold">曲の属性で絞り込み（OR検索）:</label>
            </div>
            <div class="checkboxlist">
                <div class="checkbox">
                    <input type="checkbox" id="aqours">
                    <label for="chikaCheckbox">全員曲</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="unit">
                    <label for="rikoCheckbox">ユニット</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="solo">
                    <label for="rikoCheckbox">ソロ</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="grade">
                    <label for="rikoCheckbox">学年</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="duoTrio">
                    <label for="rikoCheckbox">デュオトリオ（ヨハネ含む）</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="saintAqoursSnow">
                    <label for="rikoCheckbox">セイントアクアスノー</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="yohane">
                    <label for="rikoCheckbox">幻日のヨハネ</label>
                </div>
                <div class="checkbox">
                    <input type="checkbox" id="small">
                    <label for="rikoCheckbox">その他少人数編成</label>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="title">
                <label for="filterInput" class="fw-bold">その他設定:</label>
            </div>
            <div class="checkboxlist row">
                <div class="checkbox col-12">
                    <input type="checkbox" id="highlight" checked>
                    <label for="chikaCheckbox">検索キーワードをハイライトする</label>
                </div>
                <div class="checkbox col-12">
                    <input type="checkbox" id="index" checked>
                    <label for="chikaCheckbox">目次を表示する</label>
                </div>
                <div class="checkbox col-12">
                    <input type="checkbox" id="rowDisplay" checked>
                    <label for="chikaCheckbox">横並びで表示する</label>
                </div>
            </div>
        </div>

        <div class="setting">
            <div class="title">
                <label for="filterInput" class="fw-bold">その他の機能:</label>
            </div>
            <div class="d-flex">
                <div class="serch-execute me-2">
                    <button id="clearButton">検索条件をクリア</button>
                </div>
                <div class="serch-execute me-2">
                    <button id="showSelected">チェックした楽曲を表示</button>
                </div>
                <div class="serch-execute">
                    <button id="hintButton">ヒント</button>
                </div>
            </div>
        </div>

        <div class="setting">
            <div class="title">
                <label for="filterInput" class="fw-bold">検索実行:</label>
            </div>
            <div class="serch-execute">
                <button id="filterButton">検索</button>
            </div>
        </div>
        <div id="index-container" class="index-container row"></div>
        <div id="songs-container" class="songs-container row"></div>
    </div>
    </div>
    </div>
    </div>

    <script>
        // service workerの登録関係
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service_worker.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        }
        // CSVファイルのパス（dataフォルダ内）
        const songFilePath = 'data/songs.csv';
        const hintFilePath = 'data/hint.json';
        let songs;
        let hints;
        const settingIds = ["highlight", "index", "rowDisplay"];
        const songElements = {
            title: {
                type: "includes"
            },
            lyrics: {
                type: "includes"
            },
            writer: {
                type: "includes"
            },
            arrangement: {
                type: "includes"
            },
            lyrics: {
                type: "includes"
            },
            chika: {
                type: "member"
            },
            riko: {
                type: "member"
            },
            kanan: {
                type: "member"
            },
            dia: {
                type: "member"
            },
            you: {
                type: "member"
            },
            yoshiko: {
                type: "member"
            },
            hanamaru: {
                type: "member"
            },
            mari: {
                type: "member"
            },
            ruby: {
                type: "member"
            },
            cyaron: {
                type: "member"
            },
            azalea: {
                type: "member"
            },
            guiltyKiss: {
                type: "member"
            },
            yyy: {
                type: "member"
            },
            saintSnow: {
                type: "member"
            },
            aqours: {
                type: "attribute"
            },
            unit: {
                type: "attribute"
            },
            solo: {
                type: "attribute"
            },
            grade: {
                type: "attribute"
            },
            duoTrio: {
                type: "attribute"
            },
            saintAqoursSnow: {
                type: "attribute"
            },
            yohane: {
                type: "attribute"
            },
            small: {
                type: "attribute"
            }
        }
        const filterLabels = Object.keys(songElements);
        let filterConditions = {
            title: {
                value: [],
                orSearch: false
            },
            lyrics: {
                value: [],
                orSearch: false
            },
            writer: {
                value: [],
                orSearch: false
            },
            arrangement: {
                value: [],
                orSearch: false
            },
            lyrics: {
                value: [],
                orSearch: false
            }
        };

        // ページが読み込まれたときにCSVを読み込む
        window.onload = function() {
            readQuery();
            fetch(songFilePath)
                .then(response => response.text())  // CSVファイルをテキストとして取得
                .then(csvContent => {
                    songs = parseCSV(csvContent);  // CSVの内容を解析
                    songs.forEach( song => {
                        song.selected = false;
                    })
                    console.log(filterConditions);
                    getCondition();
                    displaySongs(filteredSongs(filterConditions));
                })
                .catch(error => {
                    console.error('CSVファイルの読み込みエラー:', error);
                });
            
            fetch(hintFilePath)
                .then(response => response.json())  // CSVファイルをテキストとして取得
                .then(hintJson => {
                    hints = hintJson;
                    console.log(hints);
                })
                .catch(error => {
                    console.error('CSVファイルの読み込みエラー:', error);
                });
        };

        // 検索実行時の処理
        document.getElementById('filterButton').addEventListener('click', function() {
            // 入力フォームから検索条件を読み込み
            updateList();
        });

        settingIds.forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                updateList();
            })
        })
        
        function updateList() {
            getCondition();
            console.log(filterConditions);
            updateQuery()
            displaySongs(filteredSongs(filterConditions));
        }

        // 「チェックした楽曲を表示」ボタンを押したときの処理
        document.getElementById('showSelected').addEventListener('click', function() {
            // 入力フォームから検索条件を読み込み
            getCondition();
            displaySongs(songs.filter(song => song.selected));
        });

        document.getElementById('clearButton').addEventListener('click', function() {
            // 検索条件をクリア
            filterLabels.forEach(filterLabel => {
                let enteredElement = document.getElementById(filterLabel);
                if(enteredElement) {
                    if(songElements[filterLabel].type === "includes" && enteredElement.value.trim().length > 0) {
                        // 文字入力の場合はスペース区切り
                        document.getElementById(filterLabel + "_or").checked = false;
                        enteredElement.value = "";
                    } else if(songElements[filterLabel].type === "member" || songElements[filterLabel].type === "attribute") {
                        enteredElement.checked = false;
                    }
                    
                }
            })
        });

        // ヒントコーナーの曲を表示する関数
        document.getElementById('hintButton').addEventListener('click', function() {
            const indexContainer = document.getElementById('index-container');
            indexContainer.innerHTML = '';  // 既存の内容をクリア

            const container = document.getElementById('songs-container');
            container.innerHTML = '';  // 既存の内容をクリア

            getCondition();

            // 目次を表示
            if(document.getElementById("index").checked) {
                const indexTitleDiv = document.createElement('div');
                indexTitleDiv.textContent = "目次";
                indexTitleDiv.classList.add('col-12');
                indexTitleDiv.classList.add('fw-bold');
                indexTitleDiv.classList.add('fs-5');
                indexTitleDiv.classList.add('mb-2');
                indexContainer.appendChild(indexTitleDiv);
                for(let i=0; i < hints.length; i++) {
                    const hintDiv = document.createElement('div');
                    hintDiv.classList.add('hint');
                    hintDiv.classList.add('row');

                    const hintTitleDiv = document.createElement('div');
                    hintTitleDiv.classList.add('hint-title');
                    hintTitleDiv.textContent = "第" + (i+1) + "回";
                    hintDiv.appendChild(hintTitleDiv);

                    for(let j = 0; j < hints[i].length; j++ ) {
                        const displayedSong = songs.find(song => {
                            return song.id === hints[i][j];
                        });
                        const songDiv = document.createElement('div');
                        songDiv.classList.add('song');
                        if(document.getElementById("rowDisplay").checked) {
                            songDiv.classList.add('col-12');
                            songDiv.classList.add('col-lg-6');
                            songDiv.classList.add('col-xxl-4');
                        }

                        const titleDiv = document.createElement('a');
                        titleDiv.classList.add('song-title');
                        titleDiv.textContent = displayedSong.title;
                        titleDiv.classList.add('link-primary');
                        titleDiv.addEventListener('click', function() {
                            document.getElementById(hints[i][j]).scrollIntoView({
                                block: 'start'
                            });
                        });

                        songDiv.appendChild(titleDiv);
                        hintDiv.appendChild(songDiv);
                        indexContainer.appendChild(hintDiv);
                    }
                }
            }
            
            // ヒントを表示
            for(let i=0; i < hints.length; i++) {
                const hintDiv = document.createElement('div');
                hintDiv.classList.add('hint');
                hintDiv.classList.add('row');

                const hintTitleDiv = document.createElement('div');
                hintTitleDiv.classList.add('hint-title');
                hintTitleDiv.classList.add('col-12');
                hintTitleDiv.textContent = "第" + (i+1) + "回";
                hintDiv.appendChild(hintTitleDiv);

                for(let j = 0; j < hints[i].length; j++ ) {
                    // 戻るボタン
                    const backButton = document.createElement('a');
                    backButton.textContent = "トップへ戻る";
                    backButton.classList.add('link-primary');
                    backButton.addEventListener('click', function() {
                        document.getElementById('filter-conditions').scrollIntoView({
                            block: 'start'
                        });
                    });
                    const displayedSong = songs.find(song => {
                        return song.id === hints[i][j];
                    });
                    const songDiv = document.createElement('div');
                    songDiv.classList.add('song');
                    if(document.getElementById("rowDisplay").checked) {
                        songDiv.classList.add('col-12');
                        songDiv.classList.add('col-lg-6');
                        songDiv.classList.add('col-xxl-4');
                    }
                    songDiv.id = hints[i][j];

                    const titleDiv = document.createElement('div');
                    titleDiv.classList.add('song-title');
                    titleDiv.textContent = displayedSong.title;

                    const lyricsDiv = document.createElement('div');
                    lyricsDiv.classList.add('song-lyrics');
                    lyricsDiv.appendChild(highlightText(displayedSong.lyrics,filterConditions.lyrics.value, document.getElementById("highlight").checked));

                    songDiv.appendChild(titleDiv);
                    songDiv.appendChild(lyricsDiv);
                    songDiv.appendChild(backButton);
                    hintDiv.appendChild(songDiv);
                    container.appendChild(hintDiv);
                }
            }
                
        });


        // 曲名と歌詞を画面に表示する
        function displaySongs(songs) {
            const indexContainer = document.getElementById('index-container');
            indexContainer.innerHTML = '';  // 既存の内容をクリア

            // 目次を表示
            if(document.getElementById("index").checked) {
                const indexTitleDiv = document.createElement('div');
                indexTitleDiv.textContent = "目次";
                indexTitleDiv.classList.add('col-12');
                indexTitleDiv.classList.add('fw-bold');
                indexTitleDiv.classList.add('fs-5');
                indexTitleDiv.classList.add('mb-2');
                indexContainer.appendChild(indexTitleDiv);
                songs.forEach(song => {
                    const songDiv = document.createElement('div');
                    songDiv.classList.add('song');
                    if(document.getElementById("rowDisplay").checked) {
                        songDiv.classList.add('col-12');
                        songDiv.classList.add('col-lg-6');
                        songDiv.classList.add('col-xxl-4');
                    }

                    const titleDiv = document.createElement('a');
                    titleDiv.classList.add('song-title');
                    titleDiv.classList.add('link-primary');
                    titleDiv.textContent = song.title;
                    titleDiv.addEventListener('click', function() {
                        document.getElementById(song.id).scrollIntoView({
                            block: 'start',
                            behaviour: 'instant'
                        });
                    });

                    songDiv.appendChild(titleDiv);
                    indexContainer.appendChild(songDiv);
                });
            }

            // 歌詞を表示
            const songsContainer = document.getElementById('songs-container');
            songsContainer.innerHTML = '';  // 既存の内容をクリア

            songs.forEach(song => {
                const backButton = document.createElement('a');
                backButton.textContent = "トップへ戻る";
                backButton.classList.add('link-primary');
                backButton.addEventListener('click', function() {
                    document.getElementById('filter-conditions').scrollIntoView({
                        block: 'start',
                        behaviour: 'instant'
                    });
                });
                const songDiv = document.createElement('div');
                songDiv.classList.add('song');
                if(document.getElementById("rowDisplay").checked) {
                    songDiv.classList.add('col-12');
                    songDiv.classList.add('col-lg-6');
                    songDiv.classList.add('col-xxl-4');
                }
                songDiv.id = song.id;

                // 曲名とチェックボックスを入れる用のdiv
                const titleBoxDiv = document.createElement('div');
                titleBoxDiv.classList.add('d-flex');
                titleBoxDiv.classList.add('song-title');
                titleBoxDiv.classList.add('ps-2');

                // 選択状態のチェックボックス
                const selectCheck = document.createElement('input');
                selectCheck.type = 'checkbox';
                selectCheck.id = "selected-" + song.id;
                selectCheck.checked = song.selected;
                selectCheck.classList.add('me-1');
                selectCheck.addEventListener('click', function() {
                    songs.find(eachSong => eachSong.id === song.id).selected = document.getElementById("selected-" + song.id).checked;
                    console.log(song.id);
                    console.log(songs.find(eachSong => eachSong.id === song.id).selected);
                });

                // 曲名
                const titleDiv = document.createElement('div');
                titleDiv.textContent = song.title;

                const lyricsDiv = document.createElement('div');
                lyricsDiv.classList.add('song-lyrics');
                lyricsDiv.appendChild(highlightText(song.lyrics,filterConditions.lyrics.value, document.getElementById("highlight").checked));

                titleBoxDiv.appendChild(selectCheck);
                titleBoxDiv.appendChild(titleDiv);
                songDiv.appendChild(titleBoxDiv);
                songDiv.appendChild(lyricsDiv);
                songDiv.appendChild(backButton);

                songsContainer.appendChild(songDiv);
            });
        }

         /**
         * CSVをパースして配列を返す関数
         * @param {string} csvContent - CSVファイルの内容
         * @returns {Array} - オブジェクトの配列（行ごとに分かれたデータ）
         */
         function parseCSV(csvContent) {
            const rows = [];
            const parsedData = [];
            const jsonData = [];
            let insideQuotes = false;
            let currentRow = '';

            // 文字列ごとに解析
            for (let i = 0; i < csvContent.length; i++) {
                const char = csvContent[i];
                if (char === '"') {
                    insideQuotes = !insideQuotes; // クオート内外の状態を切り替える
                    currentRow += char; // 現在の列に文字を追加
                } else if (char === '\n' && !insideQuotes) {
                    rows.push(currentRow.trim()); // 改行が区切り文字として認識
                    currentRow = ''; // 新しい列の準備
                } else {
                    currentRow += char; // 現在の列に文字を追加
                }
            }

            rows.forEach(row => {
                const columns = [];
                let currentColumn = '';
                let insideQuotes = false;

                // 文字列ごとに解析
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];

                    // ダブルクオートが出てきた場合
                    if (char === '"') {
                        if (row[i-1]===',' || row[i+1]===',' || i===0 || i === row.length - 1) {
                            insideQuotes = !insideQuotes; // クオート内外の状態を切り替える
                        }
                        else if(row[i-1] !=='"') {
                            currentColumn += char;
                        }
                        
                    } else if (char === ',' && !insideQuotes) {
                        columns.push(currentColumn.trim()); // カンマが区切り文字として認識
                        currentColumn = ''; // 新しい列の準備
                    } else {
                        currentColumn += char; // 現在の列に文字を追加
                    }
                }

                // 最後の列を追加
                if (currentColumn !== '') {
                    columns.push(currentColumn.trim());
                }


                // 行をデータに追加
                parsedData.push(columns);

            });
            
            for (let i = 1; i < parsedData.length; i++) {
                let row = {};
                for (let j = 0; j < parsedData[i].length; j++) {
                    if(parsedData[i][j] === 'TRUE') {
                        row[parsedData[0][j]] = true;
                    } else if(parsedData[i][j] === 'FALSE') {
                        row[parsedData[0][j]] = false;
                    } else {
                        row[parsedData[0][j]] = parsedData[i][j];
                    }
                }
                jsonData.push(row);
            }
            console.log(jsonData);

            return jsonData;
        }

        // 曲を絞り込む
        function filteredSongs(filterCondition) {
            console.log(filterCondition);
            return songs.filter(song => {
                return checkSongs(song, filterCondition)
            });
        }

        // 曲が検索条件に当てはまるかを判定する関数
        function checkSongs(song, filterCondition) {
            let filterConditionLabels = Object.keys(filterCondition);

            // 文字列検索を実施
            let includeResult = true;
            filterConditionLabels.filter(filterConditionLabel => songElements[filterConditionLabel].type === 'includes').forEach(filterConditionLabel => {
                // and検索ならtrueから始めて不一致条件があればfalseにする。or検索ならfalseから初めて一致条件があればtrueにする
                let eachResult = !filterCondition[filterConditionLabel].orSearch;
                if(filterCondition[filterConditionLabel].orSearch && filterCondition[filterConditionLabel].value.length === 0) {
                    eachResult = true;
                }
                filterCondition[filterConditionLabel].value.forEach(keyword => {
                    // 検索キーワードが含まれていた場合の処理
                    if(song[filterConditionLabel].toLowerCase().includes(keyword)) {
                        // or検索なら結果をtrueにする
                        if(filterCondition[filterConditionLabel].orSearch) {
                            eachResult = true;
                        }
                    } else {
                        // 検索キーワードが含まれていなかった場合の処理
                        // and検索なら結果をfalseにする
                        if(!filterCondition[filterConditionLabel].orSearch) {
                            eachResult = false;
                        }
                    }
                })
                if(!eachResult) {
                    includeResult = false;
                }
            })

            if(!includeResult) {
                return false
            }

            // メンバー検索を実施。OR条件で検索する
            const memberConditionsLabels = filterConditionLabels.filter(filterConditionLabel => songElements[filterConditionLabel].type === 'member' && filterCondition[filterConditionLabel] === true);
            let memberResult = true;
            if(memberConditionsLabels.length > 0) {
                memberResult = false;
                memberConditionsLabels.forEach(filterConditionLabel => {
                    if(song[filterConditionLabel] === filterCondition[filterConditionLabel]) {
                        memberResult = true;
                    }
                })
            }

            if(!memberResult) {
                return false
            }

            // 属性検索を実施。OR条件で検索する
            const attributeConditionsLabels = filterConditionLabels.filter(filterConditionLabel => songElements[filterConditionLabel].type === 'attribute' && filterCondition[filterConditionLabel] === true);
            let attributeResult = true;
            if(attributeConditionsLabels.length > 0) {
                attributeResult = false;
                attributeConditionsLabels.forEach(filterConditionLabel => {
                    if(song[filterConditionLabel] === filterCondition[filterConditionLabel]) {
                        attributeResult = true;
                    }
                })
            }

            
            if(!attributeResult) {
                return false
            }

            return true;
        }

        // ハイライトして表示するための関数
        function highlightText(text, condition, setting) {
            // 結果を入れるためのdivタグを作成
            const textDiv = document.createElement('div');

            if(condition.length === 0 || !setting) {
                textDiv.textContent = text;
                return textDiv;
            }

            // 検索キーワードで分割
            const separator = RegExp("(" + condition.join("|") + ")");
            splitedTexts = text.split(separator);

            const conditionRegex = RegExp("^" + condition.join("|") + "$");
            // spanタグに分割し、検索キーワードに該当する時だけハイライトのクラスを入れる
            splitedTexts.forEach(splitedText => {
                const span = document.createElement('span');
                span.textContent = splitedText;
                if(conditionRegex.test(splitedText)) {
                    span.classList.add('highlight');
                }
                textDiv.appendChild(span);
            })

            return textDiv
        }

        // 入力フォームの検索条件を読み込む関数
        function getCondition() {
            filterLabels.forEach(filterLabel => {
                let enteredElement = document.getElementById(filterLabel);
                if(enteredElement) {
                    if(songElements[filterLabel].type === "includes") {
                        if(enteredElement.value.trim().length > 0) {
                            // 文字入力の場合はスペース区切り
                            filterConditions[filterLabel] = { orSearch: document.getElementById(filterLabel + "_or").checked };
                            filterConditions[filterLabel].value = enteredElement.value.toLowerCase().split(/ |　/);
                        } else {
                            filterConditions[filterLabel] = { orSearch: document.getElementById(filterLabel + "_or").checked };
                            filterConditions[filterLabel].value = [];
                        }
                    } else if(songElements[filterLabel].type === "member" || songElements[filterLabel].type === "attribute") {
                        filterConditions[filterLabel] = enteredElement.checked;
                    }
                }
            })
        }

        function updateQuery() {
            const url = new URL(window.location.href);
            url.search = '';
            filterLabels.forEach(filterLabel => {
                if(songElements[filterLabel].type === "includes") {
                    if(filterConditions[filterLabel].value.length) {
                        url.searchParams.set(filterLabel, filterConditions[filterLabel].value.join(' '));
                    } 
                    if(filterConditions[filterLabel].orSearch) {
                        url.searchParams.set(filterLabel + "_or", filterConditions[filterLabel].orSearch);
                    } 
                } else if(songElements[filterLabel].type === "member" || songElements[filterLabel].type === "attribute") {
                    if(filterConditions[filterLabel]) {
                        url.searchParams.set(filterLabel, filterConditions[filterLabel]);
                    }
                }
            })
            if(document.getElementById("highlight").checked) {
                url.searchParams.set("highlight", document.getElementById("highlight").checked);
            }
            if(document.getElementById("index").checked) {
                url.searchParams.set("index", document.getElementById("index").checked);
            }
            if(document.getElementById("rowDisplay").checked) {
                url.searchParams.set("rowDisplay", document.getElementById("rowDisplay").checked);
            }

            console.log(url);
            // URLを更新
            window.history.pushState({}, '', url);
        }

        function readQuery() {
            const urlParams = new URLSearchParams(window.location.search);
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);

            // すべてのキーを取得
            const keys = Array.from(params.keys());
            keys.forEach(filterLabel => {
                if(filterLabels.includes(filterLabel)) {
                    console.log(filterLabel);
                    if(songElements[filterLabel].type === "includes") {
                        filterConditions[filterLabel].value = urlParams.get(filterLabel);
                        document.getElementById(filterLabel).value = urlParams.get(filterLabel);
                    } else if(songElements[filterLabel].type === "member" || songElements[filterLabel].type === "attribute") {
                        filterConditions[filterLabel] = urlParams.get(filterLabel);
                        document.getElementById(filterLabel).checked = urlParams.get(filterLabel);
                    }
                } else {
                    if(urlParams.get(filterLabel) === "true") {
                        document.getElementById(filterLabel).checked = true;
                    } 
                }
            })
        }
        
    </script>

</body>
</html>
